From 039972261f796edaa53cf400869e232436ca6440 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Mon, 14 May 2018 15:00:49 +0200
Subject: [PATCH 1/1] Make tests work even with UPDATE_INDEX=True
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

See https://github.com/WeblateOrg/docker/pull/78

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 weblate/trans/tests/test_autotranslate.py | 1 +
 weblate/trans/tests/test_search.py        | 5 +++++
 weblate/trans/tests/test_views.py         | 7 +++++++
 3 files changed, 13 insertions(+)

diff --git a/weblate/trans/tests/test_autotranslate.py b/weblate/trans/tests/test_autotranslate.py
index 014bf6162..6cf20080e 100644
--- a/weblate/trans/tests/test_autotranslate.py
+++ b/weblate/trans/tests/test_autotranslate.py
@@ -202,6 +202,7 @@ class AutoTranslationMtTest(ViewTestCase):
             new_base='',
             allow_translation_propagation=False,
         )
+        self.update_fulltext_index()
 
     def test_none(self):
         """Test for automatic translation with no content."""
diff --git a/weblate/trans/tests/test_search.py b/weblate/trans/tests/test_search.py
index 8538aed74..ecc727ef0 100644
--- a/weblate/trans/tests/test_search.py
+++ b/weblate/trans/tests/test_search.py
@@ -46,6 +46,7 @@ class SearchViewTest(ViewTestCase):
             language_code='cs'
         )
         self.translate_url = self.translation.get_translate_url()
+        self.update_fulltext_index()
 
     def do_search(self, params, expected, url=None):
         """Helper method for performing search test."""
@@ -373,6 +374,10 @@ class SearchViewTest(ViewTestCase):
 
 
 class SearchBackendTest(ViewTestCase):
+    def setUp(self):
+        super(SearchBackendTest, self).setUp()
+        self.update_fulltext_index()
+
     def do_index_update(self):
         self.edit_unit(
             'Hello, world!\n',
diff --git a/weblate/trans/tests/test_views.py b/weblate/trans/tests/test_views.py
index 5c2a921db..c3fe6c273 100644
--- a/weblate/trans/tests/test_views.py
+++ b/weblate/trans/tests/test_views.py
@@ -36,6 +36,9 @@ from django.core import mail
 from django.core.cache import cache
 
 from weblate.lang.models import Language
+from weblate.trans.management.commands.update_index import (
+    Command as UpdateIndexCommand
+)
 from weblate.trans.models import (
     ComponentList, WhiteboardMessage, Project, setup_group_acl,
 )
@@ -112,6 +115,10 @@ class ViewTestCase(RepoTestCase):
         self.project_url = self.project.get_absolute_url()
         self.component_url = self.component.get_absolute_url()
 
+    def update_fulltext_index(self):
+        command = UpdateIndexCommand()
+        command.do_update(100000)
+
     def make_manager(self):
         """Make user a Manager."""
         # Sitewide privileges
-- 
2.17.0

