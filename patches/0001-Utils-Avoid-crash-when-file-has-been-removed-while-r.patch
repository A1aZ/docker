From defc9402dc6b1beafd4efc180f162944b94b7593 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Thu, 8 Aug 2019 12:39:14 +0200
Subject: [PATCH 1/1] Utils: Avoid crash when file has been removed while
 rmtree
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 weblate/utils/files.py    | 4 +++-
 weblate/utils/unittest.py | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/weblate/utils/files.py b/weblate/utils/files.py
index 4eb5d938fc..6d0fa45a24 100644
--- a/weblate/utils/files.py
+++ b/weblate/utils/files.py
@@ -32,8 +32,10 @@ SCRIPTS_DIR = os.path.join(settings.BASE_DIR, 'scripts')
 EXAMPLES_DIR = os.path.join(settings.BASE_DIR, 'weblate', 'examples')
 
 
-def remove_readonly(func, path, _):
+def remove_readonly(func, path, excinfo):
     """Clear the readonly bit and reattempt the removal."""
+    if isinstance(excinfo[1], FileNotFoundError):
+        return
     os.chmod(path, stat.S_IWRITE)
     func(path)
 
diff --git a/weblate/utils/unittest.py b/weblate/utils/unittest.py
index fde969e90c..f1d6f253bb 100644
--- a/weblate/utils/unittest.py
+++ b/weblate/utils/unittest.py
@@ -41,5 +41,5 @@ class tempdir_setting(override_settings):  # noqa
     def disable(self):
         super(tempdir_setting, self).disable()
         if self._tempdir is not None:
-            shutil.rmtree(self._tempdir)
+            shutil.rmtree(self._tempdir, onerror=remove_readonly)
             self._tempdir = None
-- 
2.20.1

