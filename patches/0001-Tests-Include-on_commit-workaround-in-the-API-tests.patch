From af2813dd87f11a5a234102019e3b12df94d77839 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Fri, 10 Jan 2020 09:11:07 +0100
Subject: [PATCH 1/1] Tests: Include on_commit workaround in the API tests
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Needed until https://code.djangoproject.com/ticket/30457 is fixed.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 weblate/api/tests.py | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git weblate/api/tests.py weblate/api/tests.py
index 903eab752b..a21b7e01f5 100644
--- weblate/api/tests.py
+++ weblate/api/tests.py
@@ -30,12 +30,42 @@ from weblate.trans.models import Change, Component, Project, Translation, Unit
 from weblate.trans.tests.utils import RepoTestMixin, get_test_file
 from weblate.utils.state import STATE_TRANSLATED
 
+try:
+    from unittest import mock
+except ImportError:
+    import mock
+
+
 TEST_PO = get_test_file('cs.po')
 TEST_BADPLURALS = get_test_file('cs-badplurals.po')
 TEST_SCREENSHOT = get_test_file('screenshot.png')
 
 
 class APIBaseTest(APITestCase, RepoTestMixin):
+    @classmethod
+    def setUpClass(cls):
+        """
+        TODO: Remove when immediate_on_commit function is actually implemented
+        Django Ticket #: 30456, Link: https://code.djangoproject.com/ticket/30457#no1
+        """
+        super(APIBaseTest, cls).setUpClass()
+
+        def immediate_on_commit(func, using=None):
+            func()
+
+        # Context manager executing transaction.on_commit() hooks immediately
+        # This is required when using a subclass of django.test.TestCase as all tests
+        # are wrapped in a transaction that never gets committed.
+        cls.on_commit_mgr = mock.patch(
+            'django.db.transaction.on_commit', side_effect=immediate_on_commit
+        )
+        cls.on_commit_mgr.__enter__()
+
+    @classmethod
+    def tearDownClass(cls):
+        super(APIBaseTest, cls).tearDownClass()
+        cls.on_commit_mgr.__exit__()
+
     def setUp(self):
         self.clone_test_repos()
         self.component = self.create_component()
-- 
2.25.0.rc2

