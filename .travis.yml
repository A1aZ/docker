sudo: required

language: python

matrix:
  env:
    - DEBUG=1
    - DEBUG=0

services:
  - docker

before_script:
  - docker-compose build

script:
  - sed -i "s/^WEBLATE_DEBUG=.*/WEBLATE_DEBUG=$DEBUG/" environment

  - docker-compose up -d
  - sleep 10
  - docker-compose ps
  - CONTAINER=`docker-compose ps | grep _web_ | sed 's/[[:space:]].*//'`
  - echo "Checking $CONTAINER"
  - IP=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $CONTAINER`
  - echo "IP address $IP"
  - curl "http://$IP/about/" | grep 'Powered by.*Weblate'
  - curl -O /dev/null "http://$IP/static/weblate-128.png"
  - docker-compose down

  - docker-compose run --rm weblate createadmin
  - docker-compose run -e WEBLATE_LOGLEVEL=CRITICAL --rm weblate test --noinput weblate.accounts weblate.trans weblate.lang weblate.api weblate.gitexport weblate.screenshots weblate.utils
